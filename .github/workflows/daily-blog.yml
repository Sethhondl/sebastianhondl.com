name: Daily Blog Generation

on:
  schedule:
    # Run daily at 2 PM UTC (6 AM PT / 9 AM ET)
    - cron: '0 14 * * *'
  workflow_dispatch:
    # Allow manual trigger
    inputs:
      date:
        description: 'Date to generate blog for (YYYY-MM-DD, defaults to today)'
        required: false
        type: string

jobs:
  generate-blog:
    runs-on: ubuntu-latest

    # Only run if there are transcripts to process
    # (the job will exit gracefully if no transcripts found)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git operations
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Install Claude CLI
        run: |
          npm install -g @anthropic-ai/claude-code

      - name: Authenticate Claude CLI
        env:
          CLAUDE_TOKEN: ${{ secrets.CLAUDE_TOKEN }}
        run: |
          # Set up Claude CLI with the long-lived token
          mkdir -p ~/.claude
          echo "$CLAUDE_TOKEN" | claude auth login --token-stdin

      - name: Check for transcripts
        id: check-transcripts
        run: |
          if [ -d "transcripts" ] && [ "$(ls -A transcripts 2>/dev/null)" ]; then
            echo "has_transcripts=true" >> $GITHUB_OUTPUT
            echo "Found transcripts to process"
            ls -la transcripts/
          else
            echo "has_transcripts=false" >> $GITHUB_OUTPUT
            echo "No transcripts found, skipping generation"
          fi

      - name: Generate blog post
        if: steps.check-transcripts.outputs.has_transcripts == 'true'
        run: |
          DATE_ARG=""
          if [ -n "${{ inputs.date }}" ]; then
            DATE_ARG="--date ${{ inputs.date }}"
          fi

          python scripts/daily_blog.py run --skip-push $DATE_ARG

      - name: Commit and push changes
        if: steps.check-transcripts.outputs.has_transcripts == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Add any new posts and updated index
          git add _posts/ scripts/data/project_index.json

          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add daily blog post

            Automatically generated by GitHub Actions"
            git push
          fi

      - name: Clean up old transcripts (optional)
        if: steps.check-transcripts.outputs.has_transcripts == 'true'
        run: |
          # Keep only last 7 days of transcripts to avoid repo bloat
          # Uncomment the lines below to enable cleanup
          # find transcripts/ -type d -mtime +7 -exec rm -rf {} + 2>/dev/null || true
          echo "Transcript cleanup disabled - uncomment to enable"
